# 母婴商城系统业务流程

本文档详细描述了母婴商城系统的主要业务流程，包括用户注册与登录、商品浏览与搜索、下单与支付等核心业务流程。

## 用户业务流程

### 1. 用户注册流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  填写注册  │     │  验证手机  │     │  设置密码  │     │  注册成功  │
│    信息    ├────►│    号码    ├────►│            ├────►│            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
```

**流程详情：**

1. 用户填写基本注册信息：手机号码、验证码
2. 系统发送短信验证码到用户手机
3. 用户输入验证码进行验证
4. 验证通过后，用户设置密码
5. 系统创建用户账号，并自动登录用户
6. 用户可以选择完善个人资料

**技术实现：**

- 前端：通过表单组件实现信息收集，使用倒计时组件控制验证码获取频率
- 后端：
  - 使用短信服务发送验证码
  - 采用BCrypt算法加密存储用户密码
  - 注册成功后生成JWT令牌返回给前端

### 2. 用户登录流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  账号密码  │     │  验证账号  │     │  生成令牌  │     │  登录成功  │
│    登录    ├────►│    密码    ├────►│            ├────►│            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
      │
      │
      ▼
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  短信验证  │     │  验证短信  │     │  生成令牌  │     │  登录成功  │
│  码登录    ├────►│    验证码  ├────►│            ├────►│            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
```

**流程详情：**

1. 用户可以选择账号密码登录或短信验证码登录
2. 账号密码登录：
   - 用户输入用户名/手机号/邮箱和密码
   - 系统验证账号密码正确性
   - 验证通过后生成访问令牌
3. 短信验证码登录：
   - 用户输入手机号并获取验证码
   - 系统发送短信验证码到用户手机
   - 用户输入验证码进行验证
   - 验证通过后生成访问令牌
4. 前端存储访问令牌，用于后续API请求的认证

**技术实现：**

- 使用JWT (JSON Web Token)实现无状态的用户认证
- 令牌包含：签发时间、过期时间、用户ID等关键信息
- 采用Redis存储令牌黑名单，实现令牌即时失效功能
- 设置令牌过期时间和刷新令牌机制

## 商品业务流程

### 1. 商品浏览流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  首页推荐  │     │  分类筛选  │     │  商品详情  │
│    展示    ├────►│    查询    ├────►│    页面    │
└────────────┘     └────────────┘     └────────────┘
                         │                  │
                         ▼                  ▼
                   ┌────────────┐     ┌────────────┐
                   │  搜索结果  │     │  加入购物  │
                   │    列表    │     │    车      │
                   └────────────┘     └────────────┘
```

**流程详情：**

1. 首页展示推荐商品：新品、热销品、促销商品等
2. 用户可以通过商品分类导航浏览不同类别商品
3. 用户可以使用搜索功能查找特定商品
4. 用户点击商品进入商品详情页
5. 在商品详情页，用户可以：
   - 查看商品图片、详情、规格、价格
   - 阅读用户评价
   - 选择商品规格和数量
   - 加入购物车或直接购买

**技术实现：**

- 首页推荐商品：基于Redis缓存热门商品信息，提高访问速度
- 商品搜索：使用Elasticsearch实现全文搜索和模糊匹配
- 商品列表：采用分页加载和懒加载图片技术
- 商品详情：使用轮播组件展示商品图片，选项卡展示详细信息

### 2. 商品搜索流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  输入搜索  │     │ Elasticsearch │     │  展示搜索  │
│    关键词  ├────►│    搜索    ├────►│    结果    │
└────────────┘     └────────────┘     └────────────┘
      │                                      │
      │                                      │
      ▼                                      ▼
┌────────────┐                        ┌────────────┐
│  搜索历史  │                        │  条件筛选  │
│  热门搜索  │                        │  排序过滤  │
└────────────┘                        └────────────┘
```

**流程详情：**

1. 用户在搜索框输入关键词
2. 系统提供搜索建议（基于搜索历史和热门搜索）
3. 用户提交搜索请求
4. 系统使用Elasticsearch执行搜索
5. 展示搜索结果，并提供进一步的筛选选项：
   - 按类别筛选
   - 按价格区间筛选
   - 按销量/价格/上架时间排序
6. 用户可以点击商品进入详情页

**技术实现：**

- 使用Elasticsearch实现商品搜索功能
- 搜索关键词高亮显示
- 搜索词纠错功能
- 记录搜索历史和统计热门搜索词
- 使用Redis缓存热门搜索关键词

## 购物车业务流程

### 1. 购物车操作流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  添加商品  │     │  更新购物  │     │  查看购物  │
│  到购物车  ├────►│    车      ├────►│    车      │
└────────────┘     └────────────┘     └────────────┘
                                            │
                                            │
                                            ▼
┌────────────┐     ┌────────────┐     ┌────────────┐
│  删除购物  │     │  修改商品  │     │  选择商品  │
│  车商品    │◄────┤    数量    │◄────┤    去结算  │
└────────────┘     └────────────┘     └────────────┘
```

**流程详情：**

1. 用户在商品详情页选择规格和数量，点击"加入购物车"
2. 系统将商品添加到用户的购物车中
3. 用户可以查看购物车中的商品列表
4. 在购物车中，用户可以：
   - 修改商品数量
   - 选择或取消选择商品
   - 删除购物车中的商品
   - 清空购物车
5. 用户选择需要购买的商品，点击"去结算"进入订单确认页面

**技术实现：**

- 未登录用户：使用浏览器LocalStorage存储购物车数据
- 已登录用户：将购物车数据存储在服务器端数据库中
- 用户登录时，合并LocalStorage中的购物车数据到服务器
- 实时计算商品总价和优惠信息

## 订单业务流程

### 1. 下单流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  确认订单  │     │  选择收货  │     │  提交订单  │     │  订单创建  │
│    信息    ├────►│    地址    ├────►│            ├────►│    成功    │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
      │                  │                                      │
      │                  │                                      │
      ▼                  ▼                                      ▼
┌────────────┐     ┌────────────┐                        ┌────────────┐
│  选择优惠  │     │  填写订单  │                        │  支付订单  │
│    券      │     │    备注    │                        │            │
└────────────┘     └────────────┘                        └────────────┘
```

**流程详情：**

1. 用户从购物车中选择商品，点击"去结算"
2. 进入订单确认页面，展示：
   - 待购买的商品信息
   - 收货地址列表
   - 可用优惠券
   - 配送方式
   - 订单金额明细
3. 用户选择收货地址、优惠券、配送方式，填写订单备注
4. 用户点击"提交订单"
5. 系统创建订单，扣减库存，清空购物车中已购买的商品
6. 跳转到支付页面

**技术实现：**

- 使用数据库事务确保订单创建和库存扣减的原子性
- 采用乐观锁机制处理并发库存扣减问题
- 订单创建后设置超时取消机制（定时任务）
- 快照保存订单创建时的商品信息、价格和优惠信息

### 2. 支付流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  选择支付  │     │  调用支付  │     │  支付结果  │     │  支付成功  │
│    方式    ├────►│    接口    ├────►│    回调    ├────►│            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
      │                                                        │
      │                                                        │
      ▼                                                        ▼
┌────────────┐                                          ┌────────────┐
│  取消支付  │                                          │  更新订单  │
│            │                                          │    状态    │
└────────────┘                                          └────────────┘
```

**流程详情：**

1. 用户在支付页面选择支付方式：
   - 支付宝
   - 微信支付
   - 银联支付
2. 系统调用相应的支付接口，生成支付参数
3. 前端根据支付方式打开相应的支付界面：
   - 二维码扫描
   - 重定向到支付页面
   - 调起支付APP
4. 用户在第三方支付平台完成支付
5. 支付平台通过回调通知系统支付结果
6. 系统验证支付结果的真实性，并更新订单状态
7. 展示支付结果页面，若支付成功则显示订单详情

**技术实现：**

- 集成支付宝、微信支付SDK
- 使用异步通知和同步回调双重机制确保支付结果准确性
- 支付信息加密传输
- 使用订单号和随机字符串生成唯一的支付流水号
- 支付超时自动取消机制

### 3. 订单状态流转

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  待付款    │────►│  待发货    │────►│  待收货    │────►│  待评价    │────►│  已完成    │
└────────────┘     └────────────┘     └────────────┘     └────────────┘     └────────────┘
      │
      │
      ▼
┌────────────┐
│  已取消    │
└────────────┘
```

**流程详情：**

1. 待付款：订单创建但尚未支付
   - 用户可以主动取消订单
   - 超过支付时间限制（如30分钟）后自动取消
2. 待发货：订单已支付，等待商家发货
   - 用户可以申请退款（未发货退款）
3. 待收货：商家已发货，等待用户收货
   - 用户可以确认收货
   - 用户可以申请退货退款
   - 超过一定时间（如15天）后自动确认收货
4. 待评价：用户已确认收货，可以进行评价
   - 用户可以评价订单商品
   - 超过一定时间（如15天）后自动完成
5. 已完成：订单交易完成
   - 用户可以追加评价
   - 一定时间后可以申请售后服务
6. 已取消：订单已被取消
   - 若已支付，需进行退款处理

**技术实现：**

- 使用状态机模式管理订单状态流转
- 基于Spring State Machine实现状态转换和事件处理
- 使用定时任务处理超时订单
- 记录订单状态变更历史
- 状态变更时发送消息通知用户

## 售后业务流程

### 1. 退款流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  申请退款  │     │  商家审核  │     │  退款处理  │     │  退款完成  │
│            ├────►│            ├────►│            ├────►│            │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
                         │
                         │
                         ▼
                   ┌────────────┐
                   │  拒绝退款  │
                   │            │
                   └────────────┘
```

**流程详情：**

1. 用户在订单详情页申请退款：
   - 选择退款原因
   - 填写退款说明
   - 上传凭证图片（可选）
2. 商家审核退款申请：
   - 同意退款：系统进入退款处理流程
   - 拒绝退款：需说明拒绝原因，用户可再次申请
3. 退款处理：
   - 系统调用支付平台的退款接口
   - 等待支付平台处理退款
4. 退款完成：
   - 退款金额原路返回
   - 更新订单状态
   - 通知用户退款结果

**技术实现：**

- 对接支付宝、微信支付的退款接口
- 使用退款单号跟踪退款进度
- 异步处理退款请求，定期查询退款状态
- 退款相关操作记录日志

### 2. 退货退款流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  申请退货  │     │  商家审核  │     │  用户退货  │     │  商家确认  │
│    退款    ├────►│            ├────►│            ├────►│    收货    │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
                         │                                      │
                         │                                      │
                         ▼                                      ▼
                   ┌────────────┐                        ┌────────────┐
                   │  拒绝申请  │                        │  退款处理  │
                   │            │                        │            │
                   └────────────┘                        └────────────┘
```

**流程详情：**

1. 用户申请退货退款：
   - 选择退货原因
   - 填写退货说明
   - 上传商品问题图片
2. 商家审核退货申请：
   - 同意退货：提供退货地址和联系方式
   - 拒绝退货：说明拒绝原因
3. 用户退货：
   - 用户填写快递单号
   - 系统记录物流信息
4. 商家确认收货：
   - 检查退回的商品
   - 确认是否符合退款条件
5. 退款处理：同退款流程

**技术实现：**

- 集成物流查询API，自动跟踪退货物流状态
- 使用状态机管理退货退款流程
- 设置退货超时处理机制
- 退货退款全过程通知机制

## 营销业务流程

### 1. 优惠券发放和使用流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  创建优惠  │     │  发放优惠  │     │  用户领取  │
│    券      ├────►│    券      ├────►│            │
└────────────┘     └────────────┘     └────────────┘
                                            │
                                            │
                                            ▼
                                      ┌────────────┐
                                      │  使用优惠  │
                                      │    券      │
                                      └────────────┘
```

**流程详情：**

1. 创建优惠券：
   - 设置优惠券类型（满减、折扣等）
   - 设置使用条件（满足金额、适用商品等）
   - 设置有效期
   - 设置发放数量
2. 发放优惠券：
   - 主动领取：用户在优惠券中心领取
   - 活动发放：满足特定条件自动发放
   - 注册发放：新用户注册自动发放
3. 使用优惠券：
   - 用户在下单时选择适用的优惠券
   - 系统验证优惠券的有效性和适用条件
   - 计算优惠金额并应用到订单中

**技术实现：**

- 优惠券信息存储在数据库中
- 使用Redis缓存活动期间的热门优惠券
- 优惠券领取和使用采用乐观锁确保数量准确
- 定时任务处理过期优惠券

### 2. 促销活动流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐     ┌────────────┐
│  创建促销  │     │  设置活动  │     │  发布活动  │     │  用户参与  │
│    活动    ├────►│    规则    ├────►│            ├────►│    活动    │
└────────────┘     └────────────┘     └────────────┘     └────────────┘
```

**流程详情：**

1. 创建促销活动：
   - 设置活动名称、时间范围
   - 设置活动类型（秒杀、满减、套餐等）
   - 设置参与商品和规则
2. 设置活动规则：
   - 秒杀：设置秒杀价格、数量限制
   - 满减：设置满减阶梯（如满100减10）
   - 套餐：设置套餐组合和优惠价格
3. 发布活动：
   - 预热宣传
   - 到达活动时间自动开始
4. 用户参与活动：
   - 用户选购活动商品
   - 系统自动应用活动规则计算价格
   - 下单购买

**技术实现：**

- 使用Redis存储活动信息和库存
- 秒杀活动使用Redis+消息队列处理高并发
- 采用限流和防刷措施保障系统稳定
- 使用分布式锁确保库存一致性

## 统计与分析流程

### 1. 销售数据统计流程

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  订单数据  │     │  数据处理  │     │  生成统计  │
│    收集    ├────►│    分析    ├────►│    报表    │
└────────────┘     └────────────┘     └────────────┘
```

**流程详情：**

1. 订单数据收集：
   - 收集订单基本信息
   - 收集商品销售数据
   - 收集用户购买行为
2. 数据处理与分析：
   - 按时间维度统计（日、周、月、年）
   - 按商品类别统计
   - 按用户群体统计
3. 生成统计报表：
   - 销售额报表
   - 销售量报表
   - 转化率报表
   - 用户消费报表

**技术实现：**

- 使用Elasticsearch存储和分析统计数据
- 定时任务处理数据聚合
- 数据可视化展示

## 附录

- [用户流程详细说明](./user-flow.md)
- [商品流程详细说明](./product-flow.md)
- [订单流程详细说明](./order-flow.md)
- [支付流程详细说明](./payment-flow.md)
- [营销流程详细说明](./marketing-flow.md) 